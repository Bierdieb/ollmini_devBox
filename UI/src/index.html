<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Content Security Policy for Electron app - Secure configuration -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: file:; font-src 'self' data:; connect-src 'self' http://localhost:* http://127.0.0.1:* https://ollama.com; object-src 'none'; base-uri 'self'; form-action 'self';">
    <title>Ollmini Devbox</title>
    <!-- CSS Modules - Order matters for specificity! -->
    <link rel="stylesheet" href="styles/01-base.css">
    <link rel="stylesheet" href="styles/02-layout.css">
    <link rel="stylesheet" href="styles/03-header.css">
    <link rel="stylesheet" href="styles/04-sidebars.css">
    <link rel="stylesheet" href="styles/05-chat.css">
    <link rel="stylesheet" href="styles/06-markdown.css">
    <link rel="stylesheet" href="styles/07-modals.css">
    <link rel="stylesheet" href="styles/08-responsive.css">
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <div class="left-sidebar">
            <div class="sidebar-content">
                <button class="new-chat-btn" id="newChatBtn">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" class="new-chat-icon">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    <span>New Chat</span>
                </button>
                <button class="clear-all-chats-btn" id="clearAllChatsBtn" title="Delete all chats">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                </button>
                <!-- Chat History List -->
                <div class="chat-history-list" id="chatHistoryList">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>

        <!-- Sidebar Toggle (outside sidebar) -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
            </svg>
        </button>

        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="title-status-container">
                    <h1 class="app-title">Ollmini Devbox</h1>
                    <div class="status-indicator">
                        <span class="status-dot" id="statusDot"></span>
                        <span class="status-text" id="statusText">Connecting...</span>
                    </div>
                    <div class="activity-indicator" id="activityIndicator">
                        <span class="activity-text" id="activityText">Ready</span>
                    </div>
                </div>
                <div class="context-indicator">
                    <div class="context-bar-container">
                        <div class="context-bar-fill" id="contextBarFill"></div>
                    </div>
                    <span class="context-text" id="contextText">Context: 0 / 30,000</span>
                </div>
                <div id="tokenCounter" class="token-counter" style="display: none;">
                    <span>Tokens: </span>
                    <span id="tokenInput">0</span>
                    <span> / </span>
                    <span id="tokenOutput">0</span>
                    <span> (Total: </span>
                    <span id="tokenTotal">0</span>
                    <span>)</span>
                </div>
            </div>
            <div class="header-right">
                <select id="modelSelect" class="model-select">
                    <option value="">Loading models...</option>
                </select>
                <!-- Pin Indicator -->
                <button class="pin-indicator" id="pinIndicator" title="Pinned Messages (click to toggle sidebar)">
                    <span class="pin-icon">üìå</span>
                    <span class="pin-count-text" id="headerPinnedCount">0/5</span>
                    <span class="pin-tokens-text" id="headerPinnedTokens">(0)</span>
                </button>
                <button class="icon-button" id="workingDirBtn" title="Working Directory">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                    </svg>
                </button>
                <button class="icon-button" id="dashboardBtn" title="Dashboard (Ctrl+Shift+D)">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                </button>
                <button class="icon-button" id="settingsBtn" title="Settings">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                    </svg>
                </button>
                <button class="icon-button" id="clearBtn" title="Clear Chat">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Chat Container -->
            <div class="chat-container" id="chatContainer">
                <div class="welcome-message">
                    <h2>Devbox V0.2.0b</h2>
                    <p>Ollmini LLM Client</p>
                </div>
            </div>

            <!-- Pinned Messages Sidebar -->
            <div class="pinned-sidebar" id="pinnedSidebar" style="display: none;">
                <div class="pinned-header">
                    <h3>üìå Pinned Messages</h3>
                    <div class="pinned-stats">
                        <span id="pinnedCount">0</span>/<span id="pinnedMax">5</span>
                        <span class="pinned-tokens" id="pinnedTokens">0 tokens</span>
                    </div>
                </div>
                <div class="pinned-content" id="pinnedContent">
                    <div class="pinned-placeholder">
                        <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor" opacity="0.2">
                            <path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z"/>
                        </svg>
                        <p>No pinned messages</p>
                        <p class="pinned-hint">Click pin button on messages to pin them</p>
                    </div>
                </div>
            </div>

            <!-- Pinned Sidebar Toggle Button -->
            <button class="pinned-sidebar-toggle collapsed" id="pinnedSidebarToggle">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
            </button>

        </div>

        <!-- Input Container -->
        <div class="input-container centered" id="inputContainer">
            <!-- Context Breakdown Display (Left) -->
            <div class="context-breakdown-container" id="contextBreakdownContainer" style="display: none;">
                <!-- Compact Display (Always visible) -->
                <div class="context-compact">
                    <span class="context-label">Context:</span>
                    <span id="contextUsed">0</span> / <span id="contextLimit">30,000</span>
                    <span class="context-pct" id="contextPercent">(0%)</span>
                    <button class="expand-btn" id="contextExpandBtn" title="Show breakdown">‚ñº</button>
                </div>

                <!-- Detailed Breakdown (Expandable) -->
                <div class="context-detailed" id="contextDetailed" style="display: none;">
                    <div class="context-row">
                        <span class="breakdown-label">History:</span>
                        <div class="mini-bar">
                            <div class="mini-fill history" id="historyBar"></div>
                        </div>
                        <span class="breakdown-value" id="historyTokens">0</span>
                        <span class="breakdown-pct" id="historyPercent">(0%)</span>
                    </div>
                    <div class="context-row">
                        <span class="breakdown-label">RAG:</span>
                        <div class="mini-bar">
                            <div class="mini-fill rag" id="ragBar"></div>
                        </div>
                        <span class="breakdown-value" id="ragTokens">0</span>
                        <span class="breakdown-pct" id="ragPercent">(0%)</span>
                    </div>
                    <div class="context-row">
                        <span class="breakdown-label">Tools:</span>
                        <div class="mini-bar">
                            <div class="mini-fill tools" id="toolsBar"></div>
                        </div>
                        <span class="breakdown-value" id="toolsTokens">0</span>
                        <span class="breakdown-pct" id="toolsPercent">(0%)</span>
                    </div>
                    <div class="context-row">
                        <span class="breakdown-label">System:</span>
                        <div class="mini-bar">
                            <div class="mini-fill system" id="systemBar"></div>
                        </div>
                        <span class="breakdown-value" id="systemTokens">0</span>
                        <span class="breakdown-pct" id="systemPercent">(0%)</span>
                    </div>
                </div>

                <!-- Progress Bar (Always visible) -->
                <div class="progress-bar">
                    <div class="progress-fill" id="contextProgressFill"></div>
                </div>
            </div>

            <!-- Input Right Section -->
            <div class="input-right-section">
                <div class="input-wrapper">
                <textarea
                    id="messageInput"
                    class="message-input"
                    placeholder="Nachricht eingeben..."
                    rows="1"
                ></textarea>
                <button class="send-button" id="sendBtn" data-mode="send" title="Send">
                    <svg class="send-icon" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                    <svg class="stop-icon" viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="display: none;">
                        <path d="M6 6h12v12H6z"/>
                    </svg>
                </button>
            </div>

                <!-- Code Toggle Buttons -->
                <div class="input-buttons">
                    <div class="buttons-left">
                        <button class="canvas-toggle-button" id="codeModeToggle">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                            </svg>
                            <span>Tool</span>
                        </button>
                        <button class="canvas-toggle-button" id="webSearchModeToggle" title="Toggle WebSearch Mode">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                            </svg>
                            <span>WebSearch</span>
                        </button>
                    </div>
                    <div class="buttons-right">
                        <button class="canvas-toggle-button" id="thinkingSwitch" data-level="low">
                            Thinking: <span class="thinking-level">low</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Permission Modal -->
    <div id="permission-modal" class="modal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Tool Permission Required</h3>
            <p>Model wants to execute:</p>
            <code id="perm-command" class="modal-command"></code>

            <div class="modal-buttons">
                <button id="allow-once" class="btn-primary">‚úÖ Allow Once</button>
                <button id="allow-always" class="btn-success">üîì Always Allow</button>
                <button id="deny-btn" class="btn-warning">üí¨ No, tell model what to do</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-overlay">
        <div class="settings-container">
            <div class="settings-sidebar">
                <h3>Settings</h3>
                <nav class="settings-nav">
                    <button class="settings-nav-item active" data-tab="model">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                        </svg>
                        Model Settings
                    </button>
                    <button class="settings-nav-item" data-tab="ollama">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Ollama Settings
                    </button>
                    <button class="settings-nav-item" data-tab="ui">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M12 22C6.49 22 2 17.51 2 12S6.49 2 12 2s10 4.04 10 9c0 3.31-2.69 6-6 6h-1.77c-.28 0-.5.22-.5.5 0 .12.05.23.13.33.41.47.64 1.06.64 1.67 0 1.38-1.12 2.5-2.5 2.5zm0-18c-4.41 0-8 3.59-8 8s3.59 8 8 8c.28 0 .5-.22.5-.5 0-.16-.08-.28-.14-.35-.41-.46-.63-1.05-.63-1.65 0-1.38 1.12-2.5 2.5-2.5H16c2.21 0 4-1.79 4-4 0-3.86-3.59-7-8-7z"/>
                        </svg>
                        UI Settings
                    </button>
                    <button class="settings-nav-item" data-tab="tools">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
                        </svg>
                        Tool Settings
                    </button>
                    <button class="settings-nav-item" data-tab="rag">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M9 3L5 6.99h3V14h2V6.99h3L9 3zm7 14.01V10h-2v7.01h-3L15 21l4-3.99h-3z"/>
                        </svg>
                        RAG Configuration
                    </button>
                    <button class="settings-nav-item" data-tab="workspace">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
                        </svg>
                        Working Directory
                    </button>
                    <button class="settings-nav-item" data-tab="advanced">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                        </svg>
                        Advanced
                    </button>
                </nav>
            </div>

            <div class="settings-content">
                <!-- Model Settings Tab -->
                <div class="settings-tab active" id="model-tab">
                    <h2>Model Settings</h2>
                    <p class="settings-description">Configure model parameters for inference</p>

                    <div class="settings-group">
                        <label for="temperature-slider">
                            Temperature
                            <span class="setting-value" id="temperature-value">0.70</span>
                        </label>
                        <input type="range" id="temperature-slider" min="0" max="1" step="0.05" value="0.7">
                        <p class="setting-hint">Lower = more focused, Higher = more creative</p>
                    </div>

                    <div class="settings-group">
                        <label for="context-input">
                            Context Length
                            <span class="setting-value" id="context-value">4096</span>
                        </label>
                        <input type="range" id="context-slider" min="512" max="32768" step="512" value="4096">
                        <p class="setting-hint">Maximum tokens in context window</p>
                    </div>

                    <div class="settings-group">
                        <label for="top-p-slider">
                            Top P
                            <span class="setting-value" id="top-p-value">0.90</span>
                        </label>
                        <input type="range" id="top-p-slider" min="0" max="1" step="0.05" value="0.9">
                        <p class="setting-hint">Nucleus sampling threshold</p>
                    </div>

                    <div class="settings-group">
                        <label for="top-k-input">
                            Top K
                            <span class="setting-value" id="top-k-value">40</span>
                        </label>
                        <input type="number" id="top-k-input" min="1" max="100" value="40">
                        <p class="setting-hint">Limits vocabulary to top K tokens</p>
                    </div>

                    <div class="settings-group">
                        <label for="repeat-penalty-slider">
                            Repeat Penalty
                            <span class="setting-value" id="repeat-penalty-value">1.10</span>
                        </label>
                        <input type="range" id="repeat-penalty-slider" min="0" max="2" step="0.1" value="1.1">
                        <p class="setting-hint">Penalize repeated tokens</p>
                    </div>

                    <div class="settings-group">
                        <label for="seed-input">
                            Seed (Optional)
                            <span class="setting-value" id="seed-value">Random</span>
                        </label>
                        <input type="number" id="seed-input" placeholder="Leave empty for random">
                        <p class="setting-hint">Set seed for reproducible outputs</p>
                    </div>
                </div>

                <!-- Ollama Settings Tab -->
                <div class="settings-tab" id="ollama-tab">
                    <h2>Ollama Settings</h2>
                    <p class="settings-description">Configure Ollama API connection</p>

                    <div class="settings-group">
                        <label for="ollama-endpoint-input">
                            Ollama API Endpoint
                            <span class="setting-value" id="ollama-endpoint-value">http://localhost:11434</span>
                        </label>
                        <input
                            type="text"
                            id="ollama-endpoint-input"
                            placeholder="http://localhost:11434"
                            value="http://localhost:11434"
                            class="text-input"
                        >
                        <p class="setting-hint">Format: http://host:port (default: http://localhost:11434)</p>
                    </div>

                    <div class="settings-info">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/>
                        </svg>
                        <div>
                            <strong>Note:</strong> Changes require reloading models. The connection will be tested when you save settings.
                        </div>
                    </div>

                    <div class="settings-group">
                        <label>
                            RAG System
                            <input type="checkbox" id="rag-enabled-toggle" class="settings-toggle">
                        </label>
                        <p class="setting-hint">Enable Retrieval-Augmented Generation for context-aware responses. Configure in RAG Settings tab.</p>
                    </div>

                    <div class="settings-group">
                        <label>
                            Web Search Provider
                            <span class="setting-value" id="websearch-provider-value">disabled</span>
                        </label>
                        <select id="websearch-provider-select" class="settings-select">
                            <option value="disabled">Disabled</option>
                            <option value="ollama">Ollama API (requires API key)</option>
                            <option value="searx">Searx/SearxNG (self-hosted)</option>
                        </select>
                        <p class="setting-hint">Enable web_search and web_fetch tools for model. Requires configuration below.</p>
                    </div>

                    <div class="settings-group" id="ollama-apikey-group" style="display: none;">
                        <label>
                            Ollama API Key
                            <span class="setting-value" id="ollama-apikey-value">(not set)</span>
                        </label>
                        <input
                            type="password"
                            id="ollama-apikey-input"
                            placeholder="Enter your Ollama API key"
                            value=""
                            class="text-input"
                        >
                        <p class="setting-hint">Get your API key from: <a href="https://ollama.com/settings/keys" target="_blank" style="color: #61afef;">ollama.com/settings/keys</a></p>
                    </div>

                    <div class="settings-group" id="searx-url-group" style="display: none;">
                        <label>
                            Searx/SearxNG Instance URL
                            <span class="setting-value" id="searx-url-value">(not set)</span>
                        </label>
                        <input
                            type="text"
                            id="searx-url-input"
                            placeholder="http://localhost:8888"
                            value=""
                            class="text-input"
                        >
                        <p class="setting-hint">URL of your self-hosted Searx/SearxNG instance (format: http://host:port)</p>
                    </div>

                    <!-- Model Setup Section -->
                    <div class="settings-group">
                        <label>
                            Custom Model Setup
                        </label>
                        <p class="setting-hint">Install Ollmini-optimized modelfiles to your Ollama instance</p>

                        <!-- Auto-Setup Section -->
                        <div class="model-setup-auto" id="model-setup-auto">
                            <h4>‚öôÔ∏è Auto-Setup (Localhost Ollama)</h4>
                            <p class="model-setup-description">Select models to install automatically. Models will be created with <code>_ollmini</code> suffix.</p>

                            <div class="modelfile-list" id="modelfile-list">
                                <div class="modelfile-loading">Loading available modelfiles...</div>
                            </div>

                            <button class="apply-models-btn" id="apply-models-btn" disabled>
                                Apply Selected Models
                            </button>

                            <div class="model-setup-status" id="model-setup-status">
                                Select models to install
                            </div>
                        </div>

                        <!-- Manual-Setup Section (Collapsible) -->
                        <div class="model-setup-manual">
                            <details>
                                <summary>üìñ Manual Setup (Remote/Docker Ollama)</summary>
                                <div class="manual-instructions">
                                    <h4>For Remote or Docker Ollama Instances</h4>

                                    <p><strong>Prerequisites:</strong></p>
                                    <ul>
                                        <li>Access to the system running Ollama</li>
                                        <li>Ollama CLI installed and running</li>
                                    </ul>

                                    <p><strong>Step 1: Copy Modelfile</strong></p>
                                    <p>Transfer the modelfile from <code>Models/</code> directory to your Ollama host.</p>

                                    <p><strong>For Docker:</strong></p>
                                    <pre>docker cp Models/gpt-oss_20b_Modelfile.txt ollama-container:/tmp/modelfile.txt</pre>

                                    <p><strong>For Remote (SSH):</strong></p>
                                    <pre>scp Models/gpt-oss_20b_Modelfile.txt user@host:/tmp/modelfile.txt</pre>

                                    <p><strong>Step 2: Create Model</strong></p>
                                    <p>Run on the Ollama host:</p>
                                    <pre>ollama create gpt-oss:20b_ollmini < /tmp/modelfile.txt</pre>

                                    <p><strong>Step 3: Verify Installation</strong></p>
                                    <pre>ollama list | grep _ollmini</pre>

                                    <p>See <a href="../Initial_Model_Setup.md" target="_blank" style="color: #61afef;">Initial_Model_Setup.md</a> for detailed instructions.</p>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>

                <!-- UI Settings Tab -->
                <div class="settings-tab" id="ui-tab">
                    <h2>UI Settings</h2>
                    <p class="settings-description">Customize interface appearance</p>

                    <div class="settings-group">
                        <label for="font-size-slider">
                            Font Size
                            <span class="setting-value" id="font-size-value">14px</span>
                        </label>
                        <input type="range" id="font-size-slider" min="12" max="20" step="1" value="14">
                        <p class="setting-hint">Chat message text size</p>
                    </div>

                    <div class="settings-group">
                        <label for="code-font-size-slider">
                            Code Font Size
                            <span class="setting-value" id="code-font-size-value">13px</span>
                        </label>
                        <input type="range" id="code-font-size-slider" min="11" max="18" step="1" value="13">
                        <p class="setting-hint">Code block and monospace text size</p>
                    </div>

                    <div class="settings-group">
                        <label for="syntax-theme-select">
                            Syntax Highlight Theme
                        </label>
                        <select id="syntax-theme-select" class="settings-select">
                            <option value="atom-one-dark">Atom One Dark</option>
                            <option value="monokai">Monokai</option>
                            <option value="github-dark">GitHub Dark</option>
                            <option value="dracula">Dracula</option>
                            <option value="nord">Nord</option>
                        </select>
                        <p class="setting-hint">Color scheme for code highlighting</p>
                    </div>

                    <div class="settings-group">
                        <label for="chat-width-slider">
                            Chat Width
                            <span class="setting-value" id="chat-width-value">85%</span>
                        </label>
                        <input type="range" id="chat-width-slider" min="70" max="95" step="5" value="85">
                        <p class="setting-hint">Width of chat messages and chain boxes</p>
                    </div>

                    <div class="settings-group">
                        <label for="input-width-slider">
                            Input Width
                            <span class="setting-value" id="input-width-value">75%</span>
                        </label>
                        <input type="range" id="input-width-slider" min="60" max="85" step="5" value="75">
                        <p class="setting-hint">Width of message input field</p>
                    </div>

                    <div class="settings-group">
                        <label>
                            Auto-scroll to Bottom
                            <input type="checkbox" id="auto-scroll-toggle" class="settings-toggle" checked>
                        </label>
                        <p class="setting-hint">Automatically scroll to new messages</p>
                    </div>

                    <div class="settings-group">
                        <label>
                            Chain of Work: Default Expanded
                            <input type="checkbox" id="chain-expanded-toggle" class="settings-toggle">
                        </label>
                        <p class="setting-hint">Show chain boxes expanded by default</p>
                    </div>

                    <div class="settings-group">
                        <label>
                            Compact Mode
                            <input type="checkbox" id="compact-mode-toggle" class="settings-toggle">
                        </label>
                        <p class="setting-hint">Reduce spacing for more content on screen</p>
                    </div>

                    <div class="settings-group">
                        <label>
                            Typewriter Effect
                            <span style="font-size: 11px; color: #e5c07b; margin-left: 8px;">(Experimental)</span>
                            <input type="checkbox" id="typewriter-toggle" class="settings-toggle">
                        </label>
                        <p class="setting-hint">Animated text reveal with orange glow effect</p>
                    </div>

                    <div class="settings-group">
                        <label>
                            Show Thinking Blocks
                            <input type="checkbox" id="show-thinking-toggle" class="settings-toggle" checked>
                        </label>
                        <p class="setting-hint">Display model's reasoning process in chat (qwen3/gpt-oss only)</p>
                    </div>
                </div>

                <!-- Tool Settings Tab -->
                <div class="settings-tab" id="tools-tab">
                    <h2>Tool Settings</h2>
                    <p class="settings-description">Configure tool behavior</p>
                    <p style="color: var(--text-secondary); margin-top: 40px;">Coming soon...</p>
                </div>

                <!-- RAG Configuration Tab -->
                <div class="settings-tab" id="rag-tab">
                    <h2>RAG Configuration</h2>
                    <p class="settings-description">Advanced RAG system settings for semantic search and retrieval</p>

                    <div class="settings-section">
                        <h3>System Status</h3>

                        <div class="settings-info" id="rag-status-info">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/>
                            </svg>
                            <div>
                                <strong id="rag-status-label">RAG System: Disabled</strong>
                                <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-secondary);">
                                    Enable RAG in <a href="#" id="link-to-ollama-settings" style="color: #61afef; text-decoration: underline;">Ollama Settings</a> to use these configuration options.
                                </p>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label>
                                Ollama Endpoint
                                <span class="live-value" id="rag-ollama-endpoint-display">http://localhost:11434</span>
                            </label>
                            <p class="setting-hint">RAG uses the same Ollama endpoint configured in Ollama Settings</p>
                        </div>

                        <!-- Active Snapshot Indicator -->
                        <div class="settings-group" id="active-snapshot-indicator" style="display: none;">
                            <div class="active-snapshot-badge">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 6px;">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/>
                                    <path d="M7 12h2v5H7zm4-3h2v8h-2zm4-3h2v11h-2z"/>
                                </svg>
                                <span style="color: #e5c07b; font-weight: 500;">Active Snapshot:</span>
                                <span id="active-snapshot-name" style="margin-left: 6px; color: #abb2bf;">-</span>
                                <button id="clear-active-snapshot-btn" class="btn-mini" title="Clear active snapshot (unlock settings)">
                                    <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                    </svg>
                                </button>
                            </div>
                            <p class="setting-hint" style="margin-top: 8px;">
                                Settings are locked to match snapshot configuration. Clear to unlock.
                            </p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Database Snapshots</h3>
                        <p class="setting-hint" style="margin-bottom: 12px;">
                            Save and load RAG database snapshots to preserve indexed content and model configurations.
                        </p>

                        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button id="save-snapshot-btn" class="btn-secondary">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 6px;">
                                    <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                                </svg>
                                Save Snapshot
                            </button>
                            <button id="load-snapshot-btn" class="btn-secondary">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 6px;">
                                    <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 15H5V5h2v3h10V5h2v13z"/>
                                </svg>
                                Load Snapshot
                            </button>
                            <button id="manage-snapshots-btn" class="btn-secondary">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 6px;">
                                    <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                                </svg>
                                Manage
                            </button>
                            <button id="clear-rag-btn" class="btn-warning">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 6px;">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                                Clear Database
                            </button>
                        </div>

                        <div class="settings-info" style="background-color: rgba(229, 192, 123, 0.1); border-color: #e5c07b;">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="#e5c07b">
                                <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/>
                            </svg>
                            <div style="color: #e5c07b;">
                                <strong>Important:</strong> Snapshots preserve embedding model, vector dimensions, and all indexed content. Loading a snapshot will automatically update RAG settings to match.
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Embedding Models (1024D)</h3>

                        <div class="settings-group">
                            <label>Code Embedding Model</label>
                            <select id="rag-code-model-select" class="text-input">
                                <option value="qwen3-embedding:0.6b">Qwen3 0.6B (639MB, Code-optimized)</option>
                                <option value="qwen3-embedding:4b">Qwen3 4B (2.5GB, Higher quality)</option>
                                <option value="snowflake-arctic-embed:335m">Arctic 335M (620MB, Generic)</option>
                                <option value="snowflake-arctic-embed2:568m">Arctic2 568M (1.08GB, Generic)</option>
                            </select>
                            <p class="setting-hint">Specialized model for code files (40+ languages)</p>
                        </div>

                        <div class="settings-group">
                            <label>Text Embedding Model</label>
                            <select id="rag-text-model-select" class="text-input">
                                <option value="snowflake-arctic-embed2:568m">Arctic2 568M (1.08GB, Best quality)</option>
                                <option value="snowflake-arctic-embed:335m">Arctic 335M (620MB, Faster)</option>
                                <option value="qwen3-embedding:0.6b">Qwen3 0.6B (639MB, Multilingual)</option>
                                <option value="qwen3-embedding:4b">Qwen3 4B (2.5GB, Higher quality)</option>
                            </select>
                            <p class="setting-hint">Model for documentation and text files</p>
                        </div>

                        <div class="settings-group">
                            <label>Embedding Strategy</label>
                            <select id="embedding-mode-select" class="text-input">
                                <option value="auto">Auto (Dual-Embedding: Code + Text separate)</option>
                                <option value="manual-text">Manual Text (Use text model for all files)</option>
                                <option value="manual-code">Manual Code (Use code model for all files)</option>
                            </select>
                            <p class="setting-hint">How to select models for different file types</p>
                        </div>

                        <div class="settings-group">
                            <label>Reranker Model <span style="font-size: 11px; color: #e5c07b;">(Optional)</span></label>
                            <select id="reranker-model-select" class="text-input">
                                <option value="">None (Disabled)</option>
                            </select>
                            <p class="setting-hint">Cross-encoder model for re-ranking search results (Stage 2)</p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Chunking Configuration</h3>

                        <div class="settings-group">
                            <label>
                                Chunk Size
                                <span class="live-value" id="chunk-size-value">512</span>
                            </label>
                            <input
                                type="range"
                                id="chunk-size-slider"
                                min="256"
                                max="2048"
                                step="64"
                                value="512"
                                class="slider"
                            >
                            <p class="setting-hint">Maximum tokens per chunk (256-2048)</p>
                        </div>

                        <div class="settings-group">
                            <label>
                                Chunk Overlap
                                <span class="live-value" id="chunk-overlap-value">50</span>
                            </label>
                            <input
                                type="range"
                                id="chunk-overlap-slider"
                                min="0"
                                max="200"
                                step="10"
                                value="50"
                                class="slider"
                            >
                            <p class="setting-hint">Token overlap between chunks (0-200)</p>
                        </div>

                        <div class="settings-group">
                            <label>
                                Semantic Chunking
                                <input type="checkbox" id="semantic-chunking-toggle" class="settings-toggle" checked>
                            </label>
                            <p class="setting-hint">Use heading-aware chunking for better structure preservation</p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Search Configuration</h3>

                        <div class="settings-group">
                            <label>
                                Stage 1: Retrieve Top K
                                <span class="live-value" id="retrieve-topk-value">20</span>
                            </label>
                            <input
                                type="range"
                                id="retrieve-topk-slider"
                                min="5"
                                max="50"
                                step="5"
                                value="20"
                                class="slider"
                            >
                            <p class="setting-hint">Number of candidates from semantic search (5-50)</p>
                        </div>

                        <div class="settings-group">
                            <label>
                                Stage 2: Rerank Top N
                                <span class="live-value" id="rerank-topn-value">3</span>
                            </label>
                            <input
                                type="range"
                                id="rerank-topn-slider"
                                min="1"
                                max="10"
                                step="1"
                                value="3"
                                class="slider"
                            >
                            <p class="setting-hint">Final number of results after re-ranking (1-10)</p>
                        </div>

                        <div class="settings-group">
                            <label>
                                Use Re-ranking <span style="font-size: 11px; color: #e5c07b;">(2-Stage Retrieval)</span>
                                <input type="checkbox" id="use-reranking-toggle" class="settings-toggle">
                            </label>
                            <p class="setting-hint">Enable 2-stage retrieval with re-ranking for better precision (requires reranker model)</p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Tool Integration</h3>

                        <div class="settings-group">
                            <label>
                                Enable Tool Integration
                                <input type="checkbox" id="tool-integration-toggle" class="settings-toggle" checked>
                            </label>
                            <p class="setting-hint">Allow LLM to automatically invoke RAG search via knowledge_search tool</p>
                        </div>

                        <div class="settings-group">
                            <label>
                                Tool Default Limit
                                <span class="live-value" id="tool-default-limit-value">3</span>
                            </label>
                            <input
                                type="range"
                                id="tool-default-limit-slider"
                                min="1"
                                max="5"
                                step="1"
                                value="3"
                                class="slider"
                            >
                            <p class="setting-hint">Default number of results when LLM calls knowledge_search (1-5)</p>
                        </div>
                    </div>
                </div>

                <!-- Working Directory Tab -->
                <div class="settings-tab" id="workspace-tab">
                    <h2>Working Directory</h2>
                    <p class="settings-description">Manage your workspace and file system</p>

                    <div class="settings-group">
                        <label>Current Working Directory</label>
                        <div class="cwd-toolbar">
                            <div class="cwd-display-card">
                                <svg class="cwd-folder-icon" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                                </svg>
                                <input type="text" id="cwd-display" class="cwd-path" readonly>
                                <div class="cwd-actions">
                                    <button id="browse-directory-btn" class="btn-icon-small" title="Browse for directory...">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                            <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                                            <path d="M14 14v-4h-4v4H7l5 5 5-5h-3z" opacity="0.7"/>
                                        </svg>
                                    </button>
                                    <button id="copy-cwd-btn" class="btn-icon-small" title="Copy path">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                        </svg>
                                    </button>
                                    <button id="refresh-explorer-btn" class="btn-icon-small" title="Refresh browser">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <button id="set-working-dir-btn" class="btn-set-directory" disabled>
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                    <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
                                </svg>
                                <span id="set-working-dir-text">Set as Working Directory (no folder selected)</span>
                            </button>
                            <button id="set-current-dir-btn" class="btn-navigate-directory" disabled>
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                    <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                                </svg>
                                <span id="set-current-dir-text">Set Current Directory (no folder selected)</span>
                            </button>
                        </div>
                        <p class="setting-hint">AI tools will use this directory as the base path for file operations</p>
                    </div>

                    <div class="settings-group">
                        <label>Retrieval Augmented Generation (RAG)</label>
                        <p class="setting-hint">
                            Index local files to provide context to the model for more accurate answers.
                            Uses the selected embedding model for vector embeddings (dynamically configurable).
                        </p>
                        <div class="rag-controls">
                            <button id="index-files-btn" class="btn-secondary">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm-1 13h-2v-2h2v2zm-1-4c-.55 0-1-.45-1-1V9c0-.55.45-1 1-1s1 .45 1 1v2c0 .55-.45 1-1 1zm5-8.27V9h5l-5-5.27z"/>
                                </svg>
                                Index Selected Files
                            </button>
                            <button id="clear-db-btn" class="btn-warning">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                                Clear Database
                            </button>
                            <button id="stop-indexing-btn" class="btn-warning" style="display: none;">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                    <path d="M6 6h12v12H6z"/>
                                </svg>
                                Stop
                            </button>
                            <div id="rag-status" class="rag-status-display">
                                Checking status...
                            </div>
                            <div id="rag-timer-container" class="rag-timer-container" style="display: none;">
                                <div id="rag-timer-elapsed" class="rag-timer-elapsed">
                                    ‚è±Ô∏è 00:00
                                </div>
                                <div id="rag-timer-eta" class="rag-timer-eta" style="display: none;">
                                    ETA: ---
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <label>File Browser</label>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                            üí° Click folder to navigate ‚Ä¢ Click file to copy path ‚Ä¢ Right-click file for "Open in Editor"
                        </p>
                        <!-- Single Panel: Folder Content with Breadcrumb -->
                        <div class="file-browser-single">
                            <div class="panel-header">
                                <div id="breadcrumb" class="breadcrumb"></div>
                            </div>
                            <div id="folder-content" class="folder-content">
                                <table class="file-list-table">
                                    <thead>
                                        <tr>
                                            <th class="col-name">Name</th>
                                            <th class="col-type">Typ</th>
                                            <th class="col-size">Gr√∂√üe</th>
                                            <th class="col-modified">Ge√§ndert</th>
                                        </tr>
                                    </thead>
                                    <tbody id="file-list-body">
                                        <tr class="loading-row">
                                            <td colspan="4" class="file-explorer-loading">
                                                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" class="spin">
                                                    <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                                                </svg>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div class="settings-tab" id="advanced-tab">
                    <h2>Advanced Settings</h2>
                    <p class="settings-description">Advanced configuration options</p>

                    <!-- Factory Reset Section -->
                    <div class="settings-section">
                        <h3>Factory Reset Options</h3>
                        <p class="settings-description">‚ö†Ô∏è Warning: These actions cannot be undone!</p>

                        <div class="advanced-reset-grid">
                            <!-- Reset RAG Databases -->
                            <button id="factory-reset-rag-btn" class="advanced-reset-btn">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                                <div class="button-content">
                                    <div class="button-title">Reset All RAG Databases</div>
                                    <div class="button-description">Deletes all indexed documents</div>
                                </div>
                            </button>

                            <!-- Reset All Chats -->
                            <button id="factory-reset-chats-btn" class="advanced-reset-btn">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                                <div class="button-content">
                                    <div class="button-title">Reset All Chats</div>
                                    <div class="button-description">Deletes complete chat history</div>
                                </div>
                            </button>

                            <!-- Reset All Settings -->
                            <button id="factory-reset-settings-btn" class="advanced-reset-btn">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
                                </svg>
                                <div class="button-content">
                                    <div class="button-title">Reset All Settings</div>
                                    <div class="button-description">Factory defaults (RAG + Search OFF)</div>
                                </div>
                            </button>

                            <!-- Master Reset Everything -->
                            <button id="factory-reset-everything-btn" class="advanced-master-reset-btn">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                                </svg>
                                <div class="button-content">
                                    <div class="button-title">‚ö†Ô∏è RESET EVERYTHING</div>
                                    <div class="button-description">RAG + Chats + Settings - DELETES ALL DATA!</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="settings-actions">
                    <button id="settings-reset" class="btn-secondary">Reset to Defaults</button>
                    <div style="flex: 1;"></div>
                    <button id="settings-cancel" class="btn-secondary">Cancel</button>
                    <button id="settings-save" class="btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Chat Modal -->
    <div id="rename-chat-modal" class="modal">
        <div class="modal-content">
            <h3>
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
                Rename Chat
            </h3>
            <p>New title:</p>
            <input type="text" id="rename-chat-input" class="text-input" placeholder="Enter chat title..." style="margin-bottom: 20px; width: 100%;">
            <div class="modal-buttons">
                <button id="rename-confirm-btn" class="btn-primary">Rename</button>
                <button id="rename-cancel-btn" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Delete Chat Modal -->
    <div id="delete-chat-modal" class="modal">
        <div class="modal-content">
            <h3>
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="display: inline-block; vertical-align: middle; margin-right: 8px; color: #e06c75;">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                Delete Chat
            </h3>
            <p>Really delete chat "<span id="delete-chat-title"></span>"?</p>
            <p style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">This action cannot be undone.</p>
            <div class="modal-buttons">
                <button id="delete-confirm-btn" class="btn-warning">Delete</button>
                <button id="delete-cancel-btn" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Clear All Chats Modal -->
    <div id="clear-all-chats-modal" class="modal">
        <div class="modal-content">
            <h3 style="color: #e06c75; font-size: 20px;">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M12 2L1 21h22L12 2zm1 16h-2v-2h2v2zm0-4h-2V9h2v5z"/>
                </svg>
                WIRKLICH alle Chats l√∂schen?
            </h3>
            <p style="font-size: 15px; margin: 16px 0;"><strong>Anzahl:</strong> <span id="chat-count-display" style="color: #e06c75; font-weight: 700;">0</span> Chats werden gel√∂scht</p>
            <p style="color: #e06c75; font-size: 14px; font-weight: 600; margin: 12px 0;">Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</p>
            <div class="modal-buttons">
                <button id="clear-all-cancel-btn" class="btn-secondary">Abbrechen</button>
                <button id="clear-all-confirm-btn" class="btn-warning" style="background: #e06c75; border-color: #e06c75;">ALLE L√ñSCHEN</button>
            </div>
        </div>
    </div>

    <!-- Save Snapshot Modal -->
    <div id="save-snapshot-modal" class="modal">
        <div class="modal-content">
            <h3>üíæ Save RAG Snapshot</h3>
            <p style="margin-bottom: 16px;">Create a snapshot of the current RAG database with all indexed content and model configuration.</p>

            <div class="snapshot-current-stats" style="background-color: rgba(97, 175, 239, 0.1); border: 1px solid #61afef; border-radius: 4px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 13px;">
                    <div style="margin-bottom: 8px;">
                        <strong>Indexed Chunks:</strong>
                        <span id="current-chunks-count" style="color: #61afef; margin-left: 6px;">-</span>
                    </div>
                    <div>
                        <strong>Embedding Models:</strong>
                        <div style="color: #61afef; margin-left: 6px; font-size: 12px;">
                            <div id="snapshot-models-display">
                                <div id="snapshot-code-model-container" style="display: none;">Code: <span id="snapshot-code-model">-</span></div>
                                <div id="snapshot-text-model-container" style="display: none;">Text: <span id="snapshot-text-model">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <label for="snapshot-name-input" style="display: block; margin-bottom: 8px; font-weight: 500;">Snapshot Name</label>
            <input type="text" id="snapshot-name-input" class="text-input" placeholder="e.g., project-docs-v1" style="width: 100%; margin-bottom: 12px;">

            <label style="display: flex; align-items: center; margin-bottom: 16px; cursor: pointer;">
                <input type="checkbox" id="auto-timestamp-checkbox" checked style="margin-right: 8px;">
                <span>Auto-add timestamp to name</span>
            </label>

            <div class="modal-buttons">
                <button id="save-snapshot-cancel-btn" class="btn-secondary">Cancel</button>
                <button id="save-snapshot-confirm-btn" class="btn-primary">Save Snapshot</button>
            </div>
        </div>
    </div>

    <!-- Load Snapshot Modal -->
    <div id="load-snapshot-modal" class="modal">
        <div class="modal-content">
            <h3>üì¶ Load RAG Snapshot</h3>

            <div class="settings-info" style="background-color: rgba(229, 192, 123, 0.1); border-color: #e5c07b; margin-bottom: 16px;">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="#e5c07b">
                    <path d="M12 2L1 21h22L12 2zm1 16h-2v-2h2v2zm0-4h-2V9h2v5z"/>
                </svg>
                <div style="color: #e5c07b; font-size: 13px;">
                    <strong>Warning:</strong> Loading will replace the current database (auto-backup will be created) and automatically update RAG settings to match the snapshot.
                </div>
            </div>

            <div id="snapshot-list-container" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;">
                <div id="snapshot-list" class="snapshot-list">
                    <!-- Dynamically populated -->
                </div>
                <div id="no-snapshots-message" style="text-align: center; color: var(--text-secondary); padding: 24px; display: none;">
                    No snapshots available. Create one first.
                </div>
            </div>

            <!-- Active Snapshots Section -->
            <div id="active-snapshots-section" style="margin-bottom: 20px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; display: none;">
                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-primary); display: flex; align-items: center;">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 6px;">
                        <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,17V16H9V14H13V13H10A1,1 0 0,1 9,12V9A1,1 0 0,1 10,8H14V9H16V11H12V12H15A1,1 0 0,1 16,13V16A1,1 0 0,1 15,17H11Z"/>
                    </svg>
                    Active Snapshots in Database
                </h4>
                <div id="active-snapshots-list" class="active-snapshots-container">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <div class="modal-buttons">
                <button id="load-snapshot-cancel-btn" class="btn-secondary">Cancel</button>
                <button id="load-snapshot-confirm-btn" class="btn-primary" disabled>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 6px;">
                        <path d="M5 4v2h14V4H5zm0 10h4v6h6v-6h4l-7-7-7 7z"/>
                    </svg>
                    Load & Replace
                </button>
                <button id="append-snapshot-btn" class="btn-primary" disabled>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 6px;">
                        <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                    </svg>
                    Append to Current
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Snapshots Modal -->
    <div id="manage-snapshots-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3>üìä Manage RAG Snapshots</h3>
            <p style="margin-bottom: 16px; color: var(--text-secondary);">View, inspect, and delete saved snapshots.</p>

            <div id="manage-snapshot-list-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
                <div id="manage-snapshot-list" class="snapshot-list">
                    <!-- Dynamically populated -->
                </div>
                <div id="no-snapshots-manage-message" style="text-align: center; color: var(--text-secondary); padding: 24px; display: none;">
                    No snapshots available.
                </div>
            </div>

            <div class="modal-buttons">
                <button id="manage-snapshots-close-btn" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Pre-Index Snapshot Confirmation Dialog -->
    <div id="pre-index-snapshot-modal" class="modal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Database Already Contains Data</h3>
            <p style="margin-bottom: 12px;">
                Current database: <strong id="pre-index-db-count" style="color: var(--accent-color);">X documents</strong>
            </p>
            <p style="margin-bottom: 16px; color: var(--text-secondary);">
                New files will be <strong>ADDED</strong> to the existing database (not replaced).
            </p>

            <label class="checkbox-label" style="display: flex; align-items: center; margin-bottom: 12px; cursor: pointer;">
                <input type="checkbox" id="save-snapshot-before-index-checkbox" checked style="margin-right: 8px; cursor: pointer;">
                <span>Save current database as snapshot first? <em style="color: var(--accent-color);">(Recommended)</em></span>
            </label>

            <input
                type="text"
                id="pre-index-snapshot-name"
                placeholder="auto_backup_2025-10-26_14-30"
                style="width: 100%; padding: 8px; margin-bottom: 16px; background: var(--background-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;"
            />

            <div class="modal-buttons">
                <button id="pre-index-continue-btn" class="btn-primary">Continue Indexing</button>
                <button id="pre-index-cancel-btn" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Chat Context Menu -->
    <div class="chat-context-menu" id="chatContextMenu">
        <button id="renameChatBtn" class="context-menu-item">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
            Rename
        </button>
        <button id="deleteChatBtn" class="context-menu-item">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
            Delete
        </button>
        <button id="toggleFavoriteBtn" class="context-menu-item">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
            </svg>
            <span id="toggleFavoriteText">Favorite</span>
        </button>
    </div>

    <script src="renderer.js"></script>
</body>
</html>
